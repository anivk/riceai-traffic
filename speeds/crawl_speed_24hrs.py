import datetime
import requests
from lxml import html
import mysql.connector
import time as timer
import sys


b = ["1303-1304", "411-412", "412-413", "413-368", "368-427", "427-465", "465-443", "443-466", "466-444", "444-440",
     "440-426", "1310-1311", "1311-1312", "1312-1313", "1314-1315", "1315-1316", "1316-1317", "425-441", "441-445",
     "445-467", "467-442", "442-396", "396-369", "369-414", "414-415", "415-416", "1305-1306", "449-451", "451-468",
     "468-453", "453-454", "454-426", "460-455", "455-456", "456-469", "469-458", "458-459", "1313-1318", "1318-1319",
     "1319-1320", "1320-1321", "1321-1322", "1322-1323", "1323-1324", "1324-1325", "1325-1326", "1326-1327",
     "1327-1339", "1338-1328", "1328-1329", "1329-1330", "1330-1331", "1331-1332", "1332-1333", "1333-1334",
     "1334-1335", "1335-1336", "1336-1337", "1337-1314", "1261-1259", "1259-1257", "1257-1255", "1255-1253",
     "1253-1251", "1251-1249", "1249-1247", "1247-1245", "1245-1243", "1243-1239", "1238-1242", "1242-1244",
     "1244-1246", "1246-1248", "1248-1250", "1250-1252", "1252-1254", "1254-1256", "1256-1258", "1258-1260", "287-64",
     "64-65", "65-66", "66-506", "1239-1237", "1237-1235", "1235-1233", "1233-1231", "1231-1229", "1229-1205",
     "1205-1206", "1206-1207", "1207-1208", "1208-1213", "1212-1201", "1201-1202", "1202-1203", "1203-1204",
     "1204-1228", "1228-1230", "1230-1232", "1232-1234", "1234-1236", "1236-1238", "508-504", "504-114", "114-116",
     "116-510", "1513-1514", "1514-1515", "1515-1502", "1502-1503", "1503-1516", "1516-1517", "1517-1518", "1518-1519",
     "1519-1520", "1520-1521", "1521-1531", "1560-1504", "1504-1505", "1505-1506", "1506-1507", "1507-1508",
     "1508-1509", "1509-1500", "1500-1501", "1501-1510", "1510-1511", "1511-1512", "382-432", "432-383", "383-384",
     "384-385", "385-436", "1531-1532", "1532-1533", "1533-1534", "1534-1535", "1535-1536", "1536-1537", "1537-1538",
     "1538-1539", "1539-1540", "1540-1541", "1541-1542", "1542-1543", "1543-1544", "1544-1545", "1546-1547",
     "1547-1548", "1548-1549", "1549-1550", "1550-1551", "1551-1552", "1552-1553", "1553-1554", "1554-1555",
     "1555-1556", "1556-1557", "1557-1558", "1558-1559", "1559-1560", "500-164", "164-165", "165-166", "166-167",
     "167-502", "1617-1615", "1615-1613", "1613-1611", "1611-1609", "1609-1607", "1607-1627", "1627-1629", "1629-1631",
     "1631-1633", "1633-1635", "1635-1602", "1602-1603", "1600-1601", "1601-1634", "1634-1632", "1632-1630",
     "1630-1628", "1628-1626", "1626-1606", "1606-1608", "1608-1610", "1610-1612", "1612-1614", "1614-1616", "36-37",
     "37-42", "1881-1882", "1882-1883", "1883-1884", "1884-1885", "1885-1886", "1886-1887", "1887-1888", "1888-1889",
     "1889-1890", "1890-1891", "1870-1871", "1871-1872", "1872-1873", "1873-1874", "1874-1875", "1875-1876",
     "1876-1877", "1877-1878", "1878-1879", "1879-1880", "1104-1105", "1105-1106", "1106-1130", "1130-1131",
     "1128-1129", "1129-1107", "1107-1100", "1100-1101", "1101-1102", "1102-1108", "1108-1109", "1109-1112",
     "1117-1110", "1110-1111", "1111-1103", "1103-1104", "1112-1113", "1113-1114", "1115-1116", "1116-1117",
     "1131-1123", "1123-1124", "1124-1125", "1125-1126", "1126-1127", "1127-1115", "1114-1118", "1118-1119",
     "1119-1120", "1120-1121", "1121-1122", "1122-1128", "90-91", "91-92", "92-93", "93-94", "94-95", "95-96", "97-98",
     "98-99", "99-100", "100-101", "101-102", "102-103", "1425-1426", "1426-1427", "1427-1428", "1428-1429",
     "1429-1430", "1430-1431", "1431-1432", "1432-1433", "1433-1434", "1434-1437", "1437-1438", "1435-1436",
     "1436-1415", "1415-1416", "1416-1417", "1417-1418", "1418-1419", "1419-1420", "1420-1421", "1421-1422",
     "1422-1423", "1423-1424", "1424-1465", "1465-1466", "1466-1468", "1468-1407", "1407-1408", "1405-1406",
     "1406-1469", "1469-1471", "1471-1472", "1472-1425", "1408-1410", "1410-1411", "1411-1412", "1412-1413",
     "1413-1461", "1461-1462", "1462-1463", "1463-1464", "1457-1458", "1458-1459", "1459-1460", "1460-1400",
     "1400-1401", "1401-1402", "1402-1403", "1403-1405", "1438-1448", "1448-1449", "1449-1450", "1450-1451",
     "1451-1452", "1452-1453", "1453-1454", "1454-1455", "1455-1456", "1456-1457", "1464-1439", "1439-1440",
     "1440-1441", "1441-1442", "1442-1443", "1443-1444", "1444-1445", "1445-1446", "1446-1447", "1447-1435",
     "1825-1826", "1826-1827", "1827-1828", "1828-1829", "1829-1830", "1830-1831", "1831-1832", "1833-1834",
     "1834-1835", "1835-1836", "1836-1837", "1837-1838", "1838-1839", "1839-1840", "1811-1812", "1812-1813",
     "1813-1814", "1814-1815", "1800-1801", "1801-1802", "1802-1803", "1803-1804", "1911-1846", "1846-1847",
     "1847-1848", "1848-1849", "1849-1850", "1851-1852", "1852-1853", "1853-1854", "1854-1855", "1855-1912",
     "1850-1856", "1856-1857", "1857-1858", "1858-1859", "1860-1861", "1861-1862", "1862-1863", "1863-1851", "346-347",
     "347-348", "348-349", "349-350", "341-342", "342-343", "343-344", "344-345", "2200-2202", "2202-2204", "2204-2206",
     "2206-2208", "2208-2210", "2210-2212", "2212-2214", "2215-2213", "2213-2211", "2211-2209", "2209-2207",
     "2207-2205", "2205-2203", "2203-2201", "2318-2319", "2319-2320", "2320-2321", "2321-2317", "2317-2315",
     "2315-2313", "2313-2311", "2311-2309", "2309-2307", "2307-2305", "2305-2303", "2303-2301", "2300-2302",
     "2302-2304", "2304-2306", "2306-2308", "2308-2310", "2310-2312", "2312-2314", "2314-2316", "2316-2322",
     "2322-2323", "2323-2324", "2324-2325", ]

"""
3 arguments:
1) segment_id
2) start datetime i.e. 2015-12-16 12:59:00
3) end datetime
"""


add_measurement = ("INSERT INTO speeds "
              "(measurement_id, speed, timestamp, measurement_timestamp, segment_id) "
              "VALUES (%s, %s, %s, %s, %s)")



start_datetime = datetime.datetime(2015, 8,01, 00, 00) #datetime.datetime.strptime(sys.argv[2], "%Y-%m-%d %H:%M:%S")
end_datetime = datetime.datetime(2015, 8,02, 00, 00)


for key in b:
    current_datetime = start_datetime

    while current_datetime <= end_datetime:
        cnx = mysql.connector.connect(user='akunapar_ani', password='ttt124!@#riceilovetianani', host='box1112.bluehost.com',
                              database='akunapar_riceai_traffic')

        timer_start = timer.time()

        current_datetime += datetime.timedelta(minutes=15)

        url = "http://traffic.houstontranstar.org/map_archive/getspeed_maparchive.aspx?src=/map_archive_data_share/{}/{}/{}/xml/speeds/{:0>2d}{:0>2d}{:0>2d}{:0>2d}&segment={}".format(
            current_datetime.year, current_datetime.month, current_datetime.day, current_datetime.month,
            current_datetime.day, current_datetime.hour, current_datetime.minute, key)

        try:
            #download page
            page = requests.get(url)
            tree = html.fromstring(page.content)

            measurement_timestamp = tree.xpath('//span[@id="lblDataAge"]/text()')[0]
            measurement_timestamp = datetime.datetime.strptime(measurement_timestamp,
                                                    "%A, %B %d, %Y %I:%M %p").strftime("%Y-%m-%d %H:%M:%S")

            speed = tree.xpath('//span[@id="lblSpeed"]/text()')
            speed = int(speed[0][:speed[0].find(" ")])

            c = cnx.cursor()
            c.execute(add_measurement, (key + " " + current_datetime.strftime("%Y-%m-%d %H:%M:%S"), speed, current_datetime, measurement_timestamp, key))
            c.close()
            cnx.commit()

            print "INSERTED:", str(timer.time()-timer_start) + "s" , (key + " " + current_datetime.strftime("%Y-%m-%d %H:%M:%S"), speed, current_datetime, measurement_timestamp, key)

            cnx.close()
        except:
            print "ERROR", url


